---
import Layout from "../../layouts/Layout.astro";
import { getAllProduits, getProduitById, getProduitsSimilaires } from "../../../backend/testback.js";

export async function getStaticPaths() {
    const { getAllProduits } = await import("../../../backend/backend.mjs");
    
    try {
        const produits = await getAllProduits();
        return produits.map((produit) => ({
            params: { id: produit.id },
        }));
    } catch (error) {
        console.error("Erreur lors de la récupération des produits:", error);
        return [];
    }
}



const { id } = Astro.params;
let produit = Astro.props.produit || await getProduitById(id);

const toutsProduits = await getAllProduits();
const produitsSimilaires = toutsProduits
    .filter(p => p.id !== produit.id && p.categorie_produit === produit.categorie_produit)
    .slice(0, 3);

// Fonction pour déterminer la couleur selon le pays
function getCouleurPays(pays) {
    switch(pays) {
        case 'Asie':
            return 'var(--color-red-main)';
        case 'Europe':
            return 'var(--color-blue-main)';
        case 'Afrique':
            return 'var(--color-green-main)';
        case 'Amérique latine':
            return 'var(--color-orange-main)';
        default:
            return 'var(--color-orange-main)';
    }
}

const couleurPays = getCouleurPays(produit.pays_produit);
---

<Layout title={produit.nom_produit} description={produit.description_produit}>
    <div class="min-h-screen bg-[var(--color-background)] relative overflow-hidden">
        
        <!-- Hero Section avec grille -->
        <section class="relative pt-8 pb-16">
            <!-- Grille colorée -->
            <div class="absolute z-0 left-1/2 -translate-x-1/2 top-[100px] pointer-events-none">
                <div class="grid grid-cols-11 grid-rows-6 gap-0" 
                     style="width: calc(100vw - 14px); max-width: 525px; margin-bottom: 25px;">
                    {Array.from({ length: 66 }).map((_, i) => (
                        <div key={i} class="aspect-square border" style={`border-color: ${couleurPays}`}></div>
                    ))}
                </div>
            </div>

            <!-- Contenu principal -->
            <div class="relative z-10 max-w-md mx-auto px-4">
                <!-- Titre -->
                <h1 class="text-4xl font-bold mb-8 font-[var(--font-logo)] text-center" 
                    style={`color: ${couleurPays}`}>
                    ALIMENT<br>
                    <span class="text-2xl">{produit.nom_produit.toUpperCase()}</span>
                </h1>

                <!-- Image et étoiles -->
                <div>
                    <div class="aspect-[4/3] bg-gray-100 overflow-hidden mb-4">
                        {produit.photo_produit ? (
                            <img src={`https://pb-yumly.leo-baudry.fr/api/files/Produit/${produit.id}/${produit.photo_produit}`}
                                 alt={produit.nom_produit}
                                 class="w-full h-full object-cover" />
                        ) : (
                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                <span>Image non disponible</span>
                            </div>
                        )}
                    </div>

                    <!-- Rating (fictif pour l'exemple) -->
                    <div class="text-white px-3 py-2 rounded-full inline-flex flex-col items-center text-sm font-medium"
                         style={`background-color: ${couleurPays}`}>
                        <span class="mb-1">RATING</span>
                        <div class="flex">
                            {Array.from({ length: 5 }).map((_, i) => (
                                <span key={i} class={i < 4 ? "text-yellow-400" : "text-gray-300"}>★</span>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Informations -->
        <section class="relative z-10 max-w-md mx-auto px-4 mb-6">
            <div class="border-l-4 pl-4 relative" style={`border-color: ${couleurPays}`}>
                <!-- Titre vertical -->
                <div class="absolute -left-12 top-0 bottom-0 flex items-center">
                    <h2 class="font-bold text-lg transform -rotate-90 whitespace-nowrap"
                        style={`color: ${couleurPays}`}>
                        INFOS
                    </h2>
                </div>

                <div class="space-y-4 ml-4">
                    <!-- Description -->
                    {produit.description_produit && (
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">DESCRIPTION :</h3>
                            <p class="text-gray-600 text-sm leading-relaxed">{produit.description_produit}</p>
                        </div>
                    )}
                    
                    <!-- Marque -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-1">MARQUE / PRODUCTEUR :</h3>
                        <p class="text-gray-600 text-sm">{produit.marque_produit}</p>
                    </div>
                    
                    <!-- Catégorie -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-1">CATÉGORIE :</h3>
                        <p class="text-gray-600 text-sm">{produit.categorie_produit}</p>
                    </div>
                    
                    <!-- Labels & Certifications -->
                    {produit.labels_certifications_produit && (
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">LABELS & CERTIFICATIONS :</h3>
                            <p class="text-gray-600 text-sm">{produit.labels_certifications_produit}</p>
                        </div>
                    )}
                    
                    <!-- Prix -->
                    {produit.prix_produit && (
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">PRIX :</h3>
                            <p class="text-gray-600 text-sm">{produit.prix_produit}</p>
                        </div>
                    )}
                </div>
            </div>
        </section>

        <!-- Section Composition -->
        <section class="relative z-10 max-w-md mx-auto px-4 mb-6">
            <div class="flex items-center mb-4">
                <div class="flex-1 h-8" style={`background-color: ${couleurPays}`}></div>
                <h2 class="px-4 text-2xl font-bold whitespace-nowrap text-center"
                    style={`color: ${couleurPays}`}>
                    COMPOSITION
                </h2>
                <div class="flex-1 h-8" style={`background-color: ${couleurPays}`}></div>
            </div>

            <!-- Ingrédients -->
            {produit.ingredients_produit && (
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">INGRÉDIENTS :</h3>
                    <p class="text-gray-600 text-sm">{produit.ingredients_produit}</p>
                </div>
            )}

            <!-- Valeurs nutritionnelles -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-800 mb-2">VALEURS NUTRITIONNELLES (POUR 100ML) :</h3>
                <div class="space-y-1 text-sm">
                    {produit.compo_energie_produit && (
                        <div class="flex justify-between">
                            <span>ÉNERGIE :</span>
                            <span>{produit.compo_energie_produit}</span>
                        </div>
                    )}
                    {produit.compo_glucides_produit && (
                        <div class="flex justify-between">
                            <span>GLUCIDES :</span>
                            <span>{produit.compo_glucides_produit}</span>
                        </div>
                    )}
                    {produit.compo_sucres_produit && (
                        <div class="flex justify-between">
                            <span>SUCRES :</span>
                            <span>{produit.compo_sucres_produit}</span>
                        </div>
                    )}
                    {produit.compo_proteines_produit && (
                        <div class="flex justify-between">
                            <span>PROTÉINES :</span>
                            <span>{produit.compo_proteines_produit}</span>
                        </div>
                    )}
                    {produit.compo_lipides_produit && (
                        <div class="flex justify-between">
                            <span>LIPIDES :</span>
                            <span>{produit.compo_lipides_produit}</span>
                        </div>
                    )}
                    {produit.compo_alcool_produit && (
                        <div class="flex justify-between">
                            <span>ALCOOL :</span>
                            <span>{produit.compo_alcool_produit}</span>
                        </div>
                    )}
                </div>
            </div>

            <!-- Allergènes -->
            {produit.compo_allergenes_produit && (
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">ALLERGÈNES :</h3>
                    <p class="text-gray-600 text-sm">{produit.compo_allergenes_produit}</p>
                </div>
            )}

            <!-- Conseils de dégustation -->
            {produit.conseil_degustation_produit && (
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">CONSEILS DE DÉGUSTATION :</h3>
                    <p class="text-gray-600 text-sm">{produit.conseil_degustation_produit}</p>
                </div>
            )}

            <!-- Conditions de conservation -->
            {produit.condition_conservation_produit && (
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">CONDITIONS DE CONSERVATION :</h3>
                    <p class="text-gray-600 text-sm">{produit.condition_conservation_produit}</p>
                </div>
            )}
        </section>

        <!-- Section Où le trouver -->
        {produit.epicerie_associe && (
            <section class="relative z-10 max-w-md mx-auto px-4 mb-6">
                <div class="flex items-center mb-4">
                    <div class="flex-1 h-8" style={`background-color: ${couleurPays}`}></div>
                    <h2 class="px-4 text-2xl font-bold whitespace-nowrap text-center"
                        style={`color: ${couleurPays}`}>
                        OÙ LE TROUVER
                    </h2>
                    <div class="flex-1 h-8" style={`background-color: ${couleurPays}`}></div>
                </div>

                <!-- Illustration épicerie -->
                <div class="w-full h-32 bg-gray-200 rounded-lg overflow-hidden mb-4 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-2 rounded-lg flex items-center justify-center"
                             style={`background-color: ${couleurPays}`}>
                            <span class="text-white text-xs font-bold">SHOP</span>
                        </div>
                        <p class="text-sm font-semibold text-gray-800">{produit.epicerie_associe}</p>
                    </div>
                </div>

                <!-- Stock -->
                {produit.stock_disponible && (
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-800 mb-1">STOCK DISPONIBLE :</h3>
                        <p class="text-gray-600 text-sm">{produit.stock_disponible}</p>
                    </div>
                )}

                <div class="text-center mt-4">
                    <button class="px-6 py-2 text-white rounded-lg font-medium"
                            style={`background-color: ${couleurPays}`}>
                        EN SAVOIR PLUS
                    </button>
                </div>
            </section>
        )}

        <!-- Section Produits qui pourraient vous plaire -->
        <section class="relative z-10 max-w-md mx-auto px-4 mb-6">
            <h2 class="text-2xl font-bold mb-4" style={`color: ${couleurPays}`}>
                PRODUITS QUI POURRAIENT<br>VOUS PLAIRE
            </h2>
            
            <!-- Carrousel produit -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-2">
                    <button class="text-gray-400" style={`hover:color: ${couleurPays}`}>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    
                    <div class="w-16 h-16 bg-red-100 rounded-lg flex items-center justify-center">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center"
                             style={`background-color: ${couleurPays}`}>
                            <span class="text-white text-xs font-bold">PRODUIT</span>
                        </div>
                    </div>
                    
                    <button class="text-gray-400" style={`hover:color: ${couleurPays}`}>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- Produits similaires -->
        {produitsSimilaires.length > 0 && (
            <section class="relative z-10 max-w-md mx-auto px-4 mb-6">
                <h2 class="text-2xl font-bold mb-4" style={`color: ${couleurPays}`}>PRODUITS SIMILAIRES</h2>
                <div class="space-y-4">
                    {produitsSimilaires.map((similaire) => (
                        <a href={`/produits/${similaire.id}`}
                           class="block p-4 border border-gray-200 rounded-lg transition-colors"
                           style={`hover:border-color: ${couleurPays}`}>
                            <h3 class="font-semibold text-gray-800">{similaire.nom_produit}</h3>
                            <p class="text-sm text-gray-600 mt-1">{similaire.marque_produit}</p>
                            <p class="text-xs mt-2" style={`color: ${couleurPays}`}>{similaire.categorie_produit}</p>
                        </a>
                    ))}
                </div>
            </section>
        )}
    </div>
</Layout>